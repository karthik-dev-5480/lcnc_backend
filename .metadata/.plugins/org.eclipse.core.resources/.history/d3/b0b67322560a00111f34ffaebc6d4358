package com.lcncbe.controller;


import com.lcncbe.dto.DataColumnRequest;
import com.lcncbe.dto.DataColumnResponse;
import com.lcncbe.dto.DataRelationshipRequest;
import com.lcncbe.dto.DataRelationshipResponse;
import com.lcncbe.dto.DataTableRequest;
import com.lcncbe.dto.DataTableResponse;
import com.lcncbe.service.DataColumnService;
import com.lcncbe.service.DataService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/data")
@CrossOrigin(origins = "*")
public class DataController {

    private final DataService dataService;
    private final DataColumnService columnService;

    public DataController(DataService dataService,DataColumnService columnService) {
        this.dataService = dataService;
        this.columnService=columnService;
    }

    // --- Table Endpoints ---

    @PostMapping("/tables")
    public ResponseEntity<DataTableResponse> createTable(@RequestBody DataTableRequest request) {
        return new ResponseEntity<>(dataService.createTable(request), HttpStatus.CREATED);
    }

    @GetMapping("/tables")
    public ResponseEntity<List<DataTableResponse>> getAllTables() {
        return ResponseEntity.ok(dataService.getAllTables());
    }

    @GetMapping("/tables/{id}")
    public ResponseEntity<DataTableResponse> getTableById(@PathVariable Long id) {
        return ResponseEntity.ok(dataService.getTableById(id));
    }

    @PutMapping("/tables/{id}")
    public ResponseEntity<DataTableResponse> updateTable(@PathVariable Long id, @RequestBody DataTableRequest request) {
        return ResponseEntity.ok(dataService.updateTable(id, request));
    }

    @DeleteMapping("/tables/{id}")
    public ResponseEntity<Void> deleteTable(@PathVariable Long id) {
        dataService.deleteTable(id);
        return ResponseEntity.noContent().build();
    }
    
    @PostMapping("/table/{tableId}/column/create")
    public ResponseEntity<DataColumnResponse> createColumn(
            @PathVariable Long tableId, 
            @RequestBody DataColumnRequest request) {
        return new ResponseEntity<>(columnService.addColumn(tableId, request), HttpStatus.CREATED);
    }

    // Fixed: Added {tableId} to the path
    @GetMapping("/table/{tableId}/column")
    public ResponseEntity<List<DataColumnResponse>> getAllColumns(@PathVariable Long tableId) {
        return ResponseEntity.ok(columnService.getColumnsByTable(tableId));
    }

    @PutMapping("/column/{columnId}")
    public ResponseEntity<DataColumnResponse> updateColumn(
            @PathVariable Long columnId, 
            @RequestBody DataColumnRequest request) {
        return ResponseEntity.ok(columnService.updateColumn(columnId, request));
    }

    @DeleteMapping("/column/{columnId}")
    public ResponseEntity<Void> deleteColumn(@PathVariable Long columnId) {
        columnService.deleteColumn(columnId);
        return ResponseEntity.noContent().build();
    }

    // --- Relationship Endpoints ---

    @PostMapping("/relationships")
    public ResponseEntity<DataRelationshipResponse> createRelationship(@RequestBody DataRelationshipRequest request) {
        return new ResponseEntity<>(dataService.createRelationship(request), HttpStatus.CREATED);
    }

    @GetMapping("/relationships")
    public ResponseEntity<List<DataRelationshipResponse>> getAllRelationships() {
        return ResponseEntity.ok(dataService.getAllRelationships());
    }

    @DeleteMapping("/relationships/{id}")
    public ResponseEntity<Void> deleteRelationship(@PathVariable Long id) {
        dataService.deleteRelationship(id);
        return ResponseEntity.noContent().build();
    }
}