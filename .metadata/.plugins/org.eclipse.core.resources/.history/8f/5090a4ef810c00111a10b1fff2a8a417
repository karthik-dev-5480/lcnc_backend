package com.lcncbe.service;


import com.lcncbe.dto.*;
import com.lcncbe.model.DataColumn;
import com.lcncbe.model.DataRelationship;
import com.lcncbe.model.DataTable;
import com.lcncbe.repository.DataColumnRepository;
import com.lcncbe.repository.DataRelationshipRepository;
import com.lcncbe.repository.DataTableRepository;

import jakarta.persistence.EntityManager;
import jakarta.persistence.ParameterMode;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.StoredProcedureQuery;

import org.jspecify.annotations.Nullable;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
public class DataServiceImplementation implements DataService,DataColumnService {

    private final DataTableRepository tableRepository;
    private final DataRelationshipRepository relationshipRepository;
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Autowired
    private DataColumnRepository columnRepository;

    public DataServiceImplementation(DataTableRepository tableRepository, DataRelationshipRepository relationshipRepository) {
        this.tableRepository = tableRepository;
        this.relationshipRepository = relationshipRepository;
    }

    // --- Table Implementation ---
    
    

    @Override
    public DataTableResponse createTable(DataTableRequest request) {
        DataTable dataTable = new DataTable();
        dataTable.setTableName(request.getTableName());
        dataTable.setDescription(request.getDescription());

        if (request.getColumns() != null) {
            List<DataColumn> columns = request.getColumns().stream()
                .map(colReq -> mapToColumnEntity(colReq, dataTable))
                .collect(Collectors.toList());
            dataTable.setColumns(columns);
        }

        DataTable savedTable = tableRepository.save(dataTable);
        return mapToTableResponse(savedTable);
    }

    @Override
    public DataTableResponse getTableById(Long id) {
        DataTable table = tableRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Table not found with id: " + id));
        return mapToTableResponse(table);
    }

    @Override
    public List<DataTableResponse> getAllTables() {
        return tableRepository.findAll().stream()
                .map(this::mapToTableResponse)
                .collect(Collectors.toList());
    }

    @Override
    public DataTableResponse updateTable(Long id, DataTableRequest request) {
        DataTable existingTable = tableRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Table not found with id: " + id));

        existingTable.setTableName(request.getTableName());
        existingTable.setDescription(request.getDescription());

        // orphanRemoval=true in Entity handles deletion of columns not in the new list
        existingTable.getColumns().clear();
        if (request.getColumns() != null) {
            List<DataColumn> newColumns = request.getColumns().stream()
                    .map(colReq -> mapToColumnEntity(colReq, existingTable))
                    .collect(Collectors.toList());
            existingTable.getColumns().addAll(newColumns);
        }

        DataTable updatedTable = tableRepository.save(existingTable);
        return mapToTableResponse(updatedTable);
    }

    @Override
    public void deleteTable(Long id) {
        tableRepository.deleteById(id);
    }

    
    @Override
    @Transactional
    public String SyncSchema(Long tableId) {
        
    	if (!tableRepository.existsById(tableId)) {
            throw new RuntimeException("Table ID " + tableId + " not found in metadata.");
        }

        // 2. Execute the Stored Procedure
        try {
            StoredProcedureQuery query = entityManager.createStoredProcedureQuery("sp_SyncTableSchema");
            
            // Map the Java parameter to the SQL parameter p_TableId
            query.registerStoredProcedureParameter("p_TableId", Long.class, ParameterMode.IN);
            query.setParameter("p_TableId", tableId);
            
            query.execute();
        } catch (Exception e) {
            // This captures SQL errors like invalid data types or constraint violations
            throw new RuntimeException("Database Sync Failed: " + e.getMessage());
        }
        return "Synced Succesfully";
		
    }
    

    // --- Relationship Implementation ---

    @Override
    public DataRelationshipResponse createRelationship(DataRelationshipRequest request) {
        DataRelationship relationship = new DataRelationship();
        
        // 1. Map simple fields
        relationship.setFkName(request.getFkName());

        // 2. Manually map Table IDs to Entity Objects
        DataTable sourceTable = tableRepository.findById(request.getSourceTableId())
                .orElseThrow(() -> new RuntimeException("Source Table not found"));
        DataTable targetTable = tableRepository.findById(request.getTargetTableId())
                .orElseThrow(() -> new RuntimeException("Target Table not found"));
                
        relationship.setSourceTable(sourceTable);
        relationship.setTargetTable(targetTable);

        // 3. Manually map Column IDs to Entity Objects
        DataColumn sourceColumn = columnRepository.findById(request.getSourceColumnId())
                .orElseThrow(() -> new RuntimeException("Source Column not found"));
        DataColumn targetColumn = columnRepository.findById(request.getTargetColumnId())
                .orElseThrow(() -> new RuntimeException("Target Column not found"));
                
        relationship.setSourceColumn(sourceColumn);
        relationship.setTargetColumn(targetColumn);

        // 4. Save the fully populated entity
        DataRelationship savedRel = relationshipRepository.save(relationship);
        return mapToRelationshipResponse(savedRel);
    }

    @Override
    public List<DataRelationshipResponse> getAllRelationships() {
        return relationshipRepository.findAll().stream()
                .map(this::mapToRelationshipResponse)
                .collect(Collectors.toList());
    }

    @Override
    public void deleteRelationship(Long id) {
        relationshipRepository.deleteById(id);
    }

    // --- Helper Mappers ---

    private DataColumn mapToColumnEntity(DataColumnRequest req, DataTable parent) {
        DataColumn col = new DataColumn();
        BeanUtils.copyProperties(req, col);
        col.setTable(parent); // Set parent for mapping
        return col;
    }

    private DataTableResponse mapToTableResponse(DataTable entity) {
        DataTableResponse response = new DataTableResponse();
        response.setId(entity.getId());
        response.setTableName(entity.getTableName());
        response.setDescription(entity.getDescription());

        if (entity.getColumns() != null) {
            List<DataColumnResponse> colResponses = entity.getColumns().stream()
                    .map(col -> {
                        DataColumnResponse colRes = new DataColumnResponse();
                        BeanUtils.copyProperties(col, colRes);
                        return colRes;
                    }).collect(Collectors.toList());
            response.setColumns(colResponses);
        }
        return response;
    }

    private DataRelationshipResponse mapToRelationshipResponse(DataRelationship entity) {
        DataRelationshipResponse response = new DataRelationshipResponse(null, null, null, null, null, null);
        BeanUtils.copyProperties(entity, response);
        return response;
    }

    @Override
    @Transactional
    public DataColumnResponse addColumn(Long tableId, DataColumnRequest request) {
    	System.out.println(request.isPrimaryKey());
        DataColumn column = mapToEntity(request);
        
        // Associate with the parent table (Assumes DataTable exists)
        DataTable table = new DataTable(); 
        table.setId(tableId);
        column.setTable(table);

        return mapToResponse(columnRepository.save(column));
    }

    @Override
    @Transactional
    public DataColumnResponse updateColumn(Long columnId, DataColumnRequest request) {
        DataColumn existing = columnRepository.findById(columnId)
                .orElseThrow(() -> new RuntimeException("Column not found with ID: " + columnId));

        // Update fields
        existing.setColumnName(request.getColumnName());
        existing.setDataType(request.getDataType());
        existing.setLength(request.getLength());
        existing.setPrecision(request.getPrecision());
        existing.setScale(request.getScale());
        existing.setPrimaryKey(request.isPrimaryKey());
        existing.setIdentity(request.isIdentity());
        existing.setRequired(request.isRequired());
        existing.setUnique(request.isUnique());
        existing.setColumnOrder(request.getColumnOrder());

        return mapToResponse(columnRepository.save(existing));
    }

    @Override
    @Transactional
    public void deleteColumn(Long columnId) {
        if (!columnRepository.existsById(columnId)) {
            throw new RuntimeException("Cannot delete. Column not found with ID: " + columnId);
        }
        columnRepository.deleteById(columnId);
    }

    @Override
    public List<DataColumnResponse> getColumnsByTable(Long tableId) {
        return columnRepository.findByTableIdOrderByColumnOrderAsc(tableId)
                .stream()
                .map(this::mapToResponse)
                .collect(Collectors.toList());
    }

    // Mapping logic
    private DataColumn mapToEntity(DataColumnRequest dto) {
        DataColumn entity = new DataColumn();
        entity.setColumnName(dto.getColumnName());
        entity.setDataType(dto.getDataType());
        entity.setLength(dto.getLength());
        entity.setPrecision(dto.getPrecision());
        entity.setScale(dto.getScale());
        entity.setPrimaryKey(dto.isPrimaryKey());
        entity.setIdentity(dto.isIdentity());
        entity.setRequired(dto.isRequired());
        entity.setUnique(dto.isUnique());
        entity.setColumnOrder(dto.getColumnOrder());
        return entity;
    }

    private DataColumnResponse mapToResponse(DataColumn entity) {
        DataColumnResponse res = new DataColumnResponse();
        res.setId(entity.getId());
        res.setColumnName(entity.getColumnName());
        res.setDataType(entity.getDataType());
        res.setLength(entity.getLength());
        res.setPrecision(entity.getPrecision());
        res.setScale(entity.getScale());
        res.setPrimaryKey(entity.isPrimaryKey());
        res.setIdentity(entity.isIdentity());
        res.setRequired(entity.isRequired());
        res.setUnique(entity.isUnique());
        res.setColumnOrder(entity.getColumnOrder());
        return res;
    }

	@Override
	public @Nullable List<DataRelationshipResponse> getTableRelationships(Long id) {
		// TODO Auto-generated method stub
		List<DataRelationship> relationships= relationshipRepository.findBySourceTableId(id);
		
		return relationships.stream()
	            .map(dr -> new DataRelationshipResponse(
	            	
	                dr.getId(),
	                dr.getFkName(),
	                dr.getSourceTable().getTableName(),
	                "test",
	                dr.getTargetTable().getTableName(),
	                "test"
	               
	            ))
	            .toList();

	}
}