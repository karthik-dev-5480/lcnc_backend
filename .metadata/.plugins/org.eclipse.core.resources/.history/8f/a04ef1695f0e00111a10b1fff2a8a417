package com.lcncbe.service;


import com.lcncbe.model.*;
import com.lcncbe.repository.*;
import com.lcncbe.service.DatasetService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

@Service
@Transactional
public class DatasetServiceImplementation implements DatasetService {

    @Autowired private DatasetRepository datasetRepo;
    @Autowired private DatasetTableRepository tableRepo;
    @Autowired private DatasetColumnRepository columnRepo;
    @Autowired private DatasetJoinRepository joinRepo;
    @Autowired private DatasetConditionRepository conditionRepo;
    @Autowired private DatasetParameterRepository paramRepo;
    
    @Autowired private JdbcTemplate jdbcTemplate;

    // Standard CRUD Implementations (Simplified for brevity)
    public Dataset saveDataset(Dataset ds) { return datasetRepo.save(ds); }
    public void deleteDataset(Long id) { datasetRepo.deleteById(id); }
    
    public DatasetTable saveTable(DatasetTable t) { return tableRepo.save(t); }
    public void deleteTable(Long id) { tableRepo.deleteById(id); }
    
    public DatasetColumn saveColumn(DatasetColumn c) { return columnRepo.save(c); }
    public void deleteColumn(Long id) { columnRepo.deleteById(id); }
    
    public DatasetJoin saveJoin(DatasetJoin j) { return joinRepo.save(j); }
    public void deleteJoin(Long id) { joinRepo.deleteById(id); }
    
    public DatasetCondition saveCondition(DatasetCondition c) { return conditionRepo.save(c); }
    public void deleteCondition(Long id) { conditionRepo.deleteById(id); }
    
    public DatasetParameter saveParameter(DatasetParameter p) { return paramRepo.save(p); }
    public void deleteParameter(Long id) { paramRepo.deleteById(id); }

    // --- DYNAMIC QUERY ENGINE ---
    @Override
    public List<Map<String, Object>> executeQuery(Long datasetId, Map<String, Object> runtimeParams) {
        Dataset ds = datasetRepo.findById(datasetId).orElseThrow();
        StringBuilder sql = new StringBuilder("SELECT ");

        // 1. Build Columns (SELECT clause)
        String selectClause = ds.getSelectedColumns().stream()
            .map(c -> c.getDatasetTable().getTableAlias() + "." + c.getDataColumn().getColumnName() + 
                 (c.getColumnAlias() != null ? " AS " + c.getColumnAlias() : ""))
            .collect(Collectors.joining(", "));
        sql.append(selectClause.isEmpty() ? "*" : selectClause);

        // 2. Build FROM & JOINS
        DatasetTable baseTable = ds.getTables().stream()
            .filter(t -> t.getTableOrder() == 1).findFirst().orElseThrow();
        sql.append(" FROM ").append(baseTable.getDataTable().getTableName()).append(" ").append(baseTable.getTableAlias());

        for (DatasetJoin join : ds.getJoins()) {
            sql.append(" ").append(join.getJoinType()).append(" JOIN ")
               .append(join.getRightDatasetTable().getDataTable().getTableName()).append(" ")
               .append(join.getRightDatasetTable().getTableAlias())
               .append(" ON ")
               .append(join.getLeftDatasetTable().getTableAlias()).append(".").append(join.getLeftColumn().getColumnName())
               .append(" = ")
               .append(join.getRightDatasetTable().getTableAlias()).append(".").append(join.getRightColumn().getColumnName());
        }

        // 3. Build WHERE Conditions
        if (!ds.getConditions().isEmpty()) {
            sql.append(" WHERE ");
            List<String> condStrings = new ArrayList<>();
            for (DatasetCondition cond : ds.getConditions()) {
                String left = cond.getLeftDatasetTable().getTableAlias() + "." + cond.getLeftColumn().getColumnName();
                String right = "?";
                
                if ("VALUE".equals(cond.getRightOperandType())) {
                    right = "'" + cond.getRightOperandValue() + "'";
                } else if ("PARAMETER".equals(cond.getRightOperandType())) {
                    right = "?"; // Placeholder for prepared statement
                }
                
                condStrings.add(left + " " + cond.getOperator() + " " + right);
            }
            sql.append(String.join(" AND ", condStrings));
        }

        // 4. Collect Parameter Values for Execution
        List<Object> jdbcParams = new ArrayList<>();
        for (DatasetCondition cond : ds.getConditions()) {
            if ("PARAMETER".equals(cond.getRightOperandType())) {
                jdbcParams.add(runtimeParams.get(cond.getRightOperandValue()));
            }
        }

        return jdbcTemplate.queryForList(sql.toString(), jdbcParams.toArray());
    }
}
