package com.lcncbe.controller;

import com.lcncbe.model.*;
import com.lcncbe.service.DatasetService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/datasets")
public class DatasetController {

    @Autowired
    private DatasetService datasetService;

    // --- DATASET CRUD (Main) ---
    @PostMapping @PutMapping
    public Dataset saveDataset(@RequestBody Dataset ds) { return datasetService.saveDataset(ds); }
    
    @DeleteMapping("/{id}")
    public void deleteDataset(@PathVariable Long id) { datasetService.deleteDataset(id); }

    // --- DATASET TABLES CRUD ---
    @PostMapping("/tables")
    public DatasetTable saveTable(@RequestBody DatasetTable table) { return datasetService.saveTable(table); }
    
    @DeleteMapping("/tables/{id}")
    public void deleteTable(@PathVariable Long id) { datasetService.deleteTable(id); }

    // --- DATASET COLUMNS CRUD ---
    @PostMapping("/columns")
    public DatasetColumn saveColumn(@RequestBody DatasetColumn col) { return datasetService.saveColumn(col); }
    
    @DeleteMapping("/columns/{id}")
    public void deleteColumn(@PathVariable Long id) { datasetService.deleteColumn(id); }

    // --- DATASET JOINS CRUD ---
    @PostMapping("/joins")
    public DatasetJoin saveJoin(@RequestBody DatasetJoin join) { return datasetService.saveJoin(join); }
    
    @DeleteMapping("/joins/{id}")
    public void deleteJoin(@PathVariable Long id) { datasetService.deleteJoin(id); }

    // --- DATASET CONDITIONS CRUD ---
    @PostMapping("/conditions")
    public DatasetCondition saveCondition(@RequestBody DatasetCondition cond) { return datasetService.saveCondition(cond); }
    
    @DeleteMapping("/conditions/{id}")
    public void deleteCondition(@PathVariable Long id) { datasetService.deleteCondition(id); }

    // --- DATASET PARAMETERS CRUD ---
    @PostMapping("/parameters")
    public DatasetParameter saveParam(@RequestBody DatasetParameter p) { return datasetService.saveParameter(p); }
    
    @DeleteMapping("/parameters/{id}")
    public void deleteParam(@PathVariable Long id) { datasetService.deleteParameter(id); }

    // --- QUERY EXECUTION (The Engine) ---
    @PostMapping("/{id}/execute")
    public Object execute(@PathVariable Long id, 
                          @RequestParam String type, 
                          @RequestBody Map<String, Object> params) {
        // type should be SELECT, INSERT, UPDATE, or DELETE
        return datasetService.executeDynamicQuery(id, type, params);
    }
}