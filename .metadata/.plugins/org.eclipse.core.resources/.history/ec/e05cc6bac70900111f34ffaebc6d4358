package com.lcncbe.service;


import com.lcncbe.dto.*;
import com.lcncbe.model.DataColumn;
import com.lcncbe.model.DataRelationship;
import com.lcncbe.model.DataTable;
import com.lcncbe.repository.DataRelationshipRepository;
import com.lcncbe.repository.DataTableRepository;

import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
public class DataServiceImplementation implements DataService {

    private final DataTableRepository tableRepository;
    private final DataRelationshipRepository relationshipRepository;

    public DataServiceImplementation(DataTableRepository tableRepository, DataRelationshipRepository relationshipRepository) {
        this.tableRepository = tableRepository;
        this.relationshipRepository = relationshipRepository;
    }

    // --- Table Implementation ---

    @Override
    public DataTableResponse createTable(DataTableRequest request) {
        DataTable dataTable = new DataTable();
        dataTable.setTableName(request.getTableName());
        dataTable.setDescription(request.getDescription());

        if (request.getColumns() != null) {
            List<DataColumn> columns = request.getColumns().stream()
                .map(colReq -> mapToColumnEntity(colReq, dataTable))
                .collect(Collectors.toList());
            dataTable.setColumns(columns);
        }

        DataTable savedTable = tableRepository.save(dataTable);
        return mapToTableResponse(savedTable);
    }

    @Override
    public DataTableResponse getTableById(Long id) {
        DataTable table = tableRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Table not found with id: " + id));
        return mapToTableResponse(table);
    }

    @Override
    public List<DataTableResponse> getAllTables() {
        return tableRepository.findAll().stream()
                .map(this::mapToTableResponse)
                .collect(Collectors.toList());
    }

    @Override
    public DataTableResponse updateTable(Long id, DataTableRequest request) {
        DataTable existingTable = tableRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Table not found with id: " + id));

        existingTable.setTableName(request.getTableName());
        existingTable.setDescription(request.getDescription());

        // orphanRemoval=true in Entity handles deletion of columns not in the new list
        existingTable.getColumns().clear();
        if (request.getColumns() != null) {
            List<DataColumn> newColumns = request.getColumns().stream()
                    .map(colReq -> mapToColumnEntity(colReq, existingTable))
                    .collect(Collectors.toList());
            existingTable.getColumns().addAll(newColumns);
        }

        DataTable updatedTable = tableRepository.save(existingTable);
        return mapToTableResponse(updatedTable);
    }

    @Override
    public void deleteTable(Long id) {
        tableRepository.deleteById(id);
    }

    // --- Relationship Implementation ---

    @Override
    public DataRelationshipResponse createRelationship(DataRelationshipRequest request) {
        DataRelationship relationship = new DataRelationship();
        BeanUtils.copyProperties(request, relationship);
        DataRelationship savedRel = relationshipRepository.save(relationship);
        return mapToRelationshipResponse(savedRel);
    }

    @Override
    public List<DataRelationshipResponse> getAllRelationships() {
        return relationshipRepository.findAll().stream()
                .map(this::mapToRelationshipResponse)
                .collect(Collectors.toList());
    }

    @Override
    public void deleteRelationship(Long id) {
        relationshipRepository.deleteById(id);
    }

    // --- Helper Mappers ---

    private DataColumn mapToColumnEntity(DataColumnRequest req, DataTable parent) {
        DataColumn col = new DataColumn();
        BeanUtils.copyProperties(req, col);
        col.setTable(parent); // Set parent for mapping
        return col;
    }

    private DataTableResponse mapToTableResponse(DataTable entity) {
        DataTableResponse response = new DataTableResponse();
        response.setId(entity.getId());
        response.setTableName(entity.getTableName());
        response.setDescription(entity.getDescription());

        if (entity.getColumns() != null) {
            List<DataColumnResponse> colResponses = entity.getColumns().stream()
                    .map(col -> {
                        DataColumnResponse colRes = new DataColumnResponse();
                        BeanUtils.copyProperties(col, colRes);
                        return colRes;
                    }).collect(Collectors.toList());
            response.setColumns(colResponses);
        }
        return response;
    }

    private DataRelationshipResponse mapToRelationshipResponse(DataRelationship entity) {
        DataRelationshipResponse response = new DataRelationshipResponse();
        BeanUtils.copyProperties(entity, response);
        return response;
    }
}